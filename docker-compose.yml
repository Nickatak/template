services:
  mysql:
    image: mysql:8.4
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-template}
      MYSQL_USER: ${MYSQL_USER:-template}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-template}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/mysql-init-grants.sh:/docker-entrypoint-initdb.d/01-mysql-init-grants.sh:ro
    ports:
      - "${MYSQL_HOST_PORT:-3306}:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 5s
      timeout: 5s
      retries: 20

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DEBUG: ${DOCKER_DEBUG:-True}
      SECRET_KEY: ${SECRET_KEY:-django-insecure-change-me-in-production}
      DATABASE_URL: ${DOCKER_DATABASE_URL:-mysql://template:template@mysql:3306/template}
      ALLOWED_HOSTS: ${DOCKER_ALLOWED_HOSTS:-localhost,127.0.0.1,backend}
      CORS_ALLOWED_ORIGINS: ${DOCKER_CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
    ports:
      - "${BACKEND_HOST_PORT:-8000}:8000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${DOCKER_NEXT_PUBLIC_API_URL:-http://localhost:8000/api}
    depends_on:
      - backend
    environment:
      NEXT_PUBLIC_API_URL: ${DOCKER_NEXT_PUBLIC_API_URL:-http://localhost:8000/api}
    ports:
      - "${FRONTEND_HOST_PORT:-3000}:3000"

volumes:
  mysql_data:
