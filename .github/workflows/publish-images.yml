name: Publish Images

on:
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  publish:
    name: Build and Publish Immutable Images
    runs-on: ubuntu-latest
    outputs:
      backend_image: ${{ steps.manifest.outputs.backend_image }}
      frontend_image: ${{ steps.manifest.outputs.frontend_image }}
      backend_digest: ${{ steps.build_backend.outputs.digest }}
      frontend_digest: ${{ steps.build_frontend.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (backend)
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Docker metadata (frontend)
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend
        id: build_backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta_backend.outputs.tags }}
          labels: ${{ steps.meta_backend.outputs.labels }}

      - name: Build and push frontend
        id: build_frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta_frontend.outputs.tags }}
          labels: ${{ steps.meta_frontend.outputs.labels }}

      - name: Attest backend provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}/backend
          subject-digest: ${{ steps.build_backend.outputs.digest }}
          push-to-registry: true

      - name: Attest frontend provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}/frontend
          subject-digest: ${{ steps.build_frontend.outputs.digest }}
          push-to-registry: true

      - name: Build release manifest
        id: manifest
        run: |
          mkdir -p artifacts
          backend_image="ghcr.io/${{ github.repository }}/backend@${{ steps.build_backend.outputs.digest }}"
          frontend_image="ghcr.io/${{ github.repository }}/frontend@${{ steps.build_frontend.outputs.digest }}"
          {
            echo "backend_image=$backend_image"
            echo "frontend_image=$frontend_image"
          } >> "$GITHUB_OUTPUT"

          cat > artifacts/release-manifest.json <<JSON
          {
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "images": {
              "backend": "$backend_image",
              "frontend": "$frontend_image"
            },
            "deployment_contract": {
              "compose_files": [
                "docker-compose.yml",
                "docker-compose.staging.yml",
                "docker-compose.edge.yml"
              ],
              "target_mode": ["docker", "prod"]
            }
          }
JSON

      - name: Upload release manifest
        uses: actions/upload-artifact@v4
        with:
          name: release-manifest-${{ github.sha }}
          path: artifacts/release-manifest.json

  scan-published-images:
    name: Scan Published Images
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Trivy scan backend image (critical only)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ needs.publish.outputs.backend_image }}
          format: table
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: '1'

      - name: Trivy scan frontend image (critical only)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ needs.publish.outputs.frontend_image }}
          format: table
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: '1'
